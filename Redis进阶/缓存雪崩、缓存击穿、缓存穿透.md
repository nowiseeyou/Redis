## 缓存雪崩 ##

### 概念 ###

大量的 key 设置了相同的过期时间，导致缓存在同一时刻全部失效，造成瞬时DB请求量过大，压力骤增，引起雪崩。

### 解决方法 ###

可以给缓存设置过期时间加上一个随机值时间，使得每个key的过期时间分布开来，不会集中在同一时刻失效。


## 缓存击穿 ##

### 概念 ###

一个存在的 key ,在缓存过期的那一刻，同时有大量的请求，这些请求都会击穿到 DB,造成瞬时 DB 请求量过大，压力骤增。

### 解决方法 ###

1. 在访问 key 之前，采用 **SETNX(set if not exists)** 来设置另一个短期 key 来锁住当前 key 的访问，访问结束再删除该短期 key 。
2. 设置热点数据永远不过期。或者加上互斥锁。

## 缓存穿透 ##

### 概念 ###

访问一个不存在的 key, 缓存不起作用，请求会穿透到DB ,流量大时 DB 会挂掉。

### 解决方法 ###

1. 采用 **布隆过滤器**，使用一个足够大的 bitmap ,用于存储可能访问的 key,不存在的 key 直接被过滤；
2. 访问 key 未在 DB 查询到值，也将空值写进缓存，但可以设置较短的过期时间。


## 总结 ##

- 事前： Redis 高可用，主从+哨兵，Redis cluster, 避免全盘崩溃。
- 事中： 本地 ehcache 缓存 + Hystrix 限流 + 降级 ， 避免 **MYSQL** 被打死。
- 事后： Redis 持久化 RDB + AOF , 一旦重启，自动从磁盘上加载数据， 快速回复 缓存数据。 

### 好处 ###

数据库绝对不会死，限流组件确保了每秒只有多少个请求能通过。只要数据库不是，就是说，对用户来说，， 3/5 的请求都是可以被处理的。 只要有 3 / 5 的请求可以被处理，就意味着你的系统没死，对用户来说，可能就是点击几次刷不出来页面，但是多点几次，就可以刷出来一次。


## Redis-避免缓存穿透的利器之BloomFilter ##


### Bloom Filter 概念 ###

布隆过滤器（Bloom Filter） 是 1970 年一个叫布隆的小伙子提出来的。它实际上是一个很长的二进制向量和一系列随机映射函数。布隆过滤器可以用于检测一个元素是否在一个集合中。它的优点是空间效率和查询时间都远远超过一般算法，缺点是有一定的误识别和删除困难。

### Bloom Filter 原理 ###

布隆过滤器的原理是，当一个元素被加入集合时，通过K个散列函数将这个元素映射成一个位数组中的K个点，把他们的位置为1。检索时，我们只要看看这些点是不是都是 1就（大约）知道集合中有没有它了： 如果这些点有任何一个0，则被检元素一定不是，如果都是1，则被检元素很可能在。这就是布隆过滤器的基本思想。

Bloom Filter 更单哈希函数 Bit-Map 不同之处在于 : Bloom Filter 使用了k 个哈希函数，每个字符串跟 k个 bit对应。从而降低了冲突的概率。

简而言之，言而简之就是我们先把我们数据库都加载到我们的过滤器中，比如数据库的Id 现在有 1，2，3。那就用id:1 为例子，他经过三次hash之后，把原本值0 的地方改为1。

下次数据进来查询的时候如果id 的值是1，那么我就把 1 拿去三次 hash 发现三次 hash 的值。跟上边的三个位置完全一样，那就能证明过滤器中有 1 的

反之 如果不一样就说明不存在了。

**应用场景：**防止缓存击穿

简单来说就是你数据库的 id 都是 1 开始然后自增的，那我知道你接口是通过 id 查询的，我就是拿负数去查询，这个时候会发现缓存里面没有数据，我又去数据库查询也没有，一个请求这样，100个 ， 1000 个， 10000个呢 ？ DB 基本就扛不住了。如果在缓存里面加上这个，是不是就不存在了，你判断没这个数据就不去查了，直接 return 一个数据为空不就好了嘛？


### Bloom Filter 的缺点 ###

bloom filter 之所以能做到在时间和空间上的效率比较高，是因为牺牲了判断的准确率，删除的便利性。

- 存在误判，可能要查到的元素没有在容器中，但是hash 之后得到的 K个位置上值都是 1。如果 bloom filter 中存储的是黑名单，那么可以通过建立一个白名单来存储可能会误判的元素。
- 删除困难，一个放入容器的元素 映射到 bit 数组的 K 个位置上是1，删除的时候不能简单的直接置为 0，可能会影响到其他元素的判断。可以蚕蛹 Counting Bloom Filter



